type: update
name: Jelasticozor Backend Cluster SSL
baseUrl: https://raw.githubusercontent.com/jelasticozor/deployment-infrastructure/master

settings:
  fields:
    - name: useDefaultExternalDomain
      type: toggle
      caption: Use Default External Domain
      value: true
      hidden: false
      showIf:
        false:
          - name: externalDomains
            caption: External domain names (;-separated list)
            type: string
            vtype: domainlist
            required: true

onInstall:
  - computeOptionalParams
  - addLoadBalancer
  - installAddon:
      id: letsencrypt
      settings:
        externalDomains: ${globals.EXTERNAL_DOMAINS}
  # TODO: they are all docker nodes in the end, so the following commands are not reliable
  - closeFromOutsideWorld:
      nodeGroup: cp
      relatedNodeGroup: bl
  - closeFromOutsideWorld:
      nodeGroup: k8sm
      relatedNodeGroup: bl
  - autoRedirectToHttps

actions:
  computeOptionalParams:
    - script: |
        return {
          result: 0,
          externalDomains: ${settings.useDefaultExternalDomain} ? "${env.domain}" : "${settings.externalDomains}"
        };
    - setGlobals:
        EXTERNAL_DOMAINS: ${response.externalDomains}
  addLoadBalancer:
    - addNodes:
        - nodeType: nginx-dockerized
          nodeGroup: bl
          count: 1
          fixedCloudlets: 1
          flexibleCloudlets: 4
  closeFromOutsideWorld:
    script: https://raw.githubusercontent.com/jelasticozor/jelastic-common/master/security/closeNodeGroupFromOutsideWorld.js
    nodeGroup: ${this.nodeGroup}
    relatedNodeGroup: ${this.relatedNodeGroup}
  autoRedirectToHttps:
    - cmd[bl]: wget ${baseUrl}/nginx/ssl.conf -O /etc/nginx/conf.d/ssl.conf
    - cmd[bl]:
        - sed -i '/#GFADMIN/,/TCP\ SECTION\ PROTOTYPE/d' /etc/nginx/nginx-jelastic.conf
        - wget ${baseUrl}/nginx/https_redirection.conf -O /tmp/https_redirection.conf
        - cat /tmp/https_redirection.conf >> /etc/nginx/nginx-jelastic.conf
      user: root
    - restartContainers[bl]

addons:
- id: letsencrypt
  name: letsencrypt
  onInstall:
  - install:
      envName: ${env.envName}
      nodeGroup: bl
      jps: https://raw.githubusercontent.com/jelastic-jps/lets-encrypt/blob/master/manifest.jps
      settings:
        customDomains: ${settings.externalDomains}