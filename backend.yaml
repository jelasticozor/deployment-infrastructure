type: install
name: Jelasticozor Backend Cluster
baseUrl: https://gitlab.hidora.com/softozor/jelasticozor/infrastructure/-/raw/master

settings:
  fields:
    - type: spacer
      caption: Kubernetes Setup
    - name: topo
      type: radio-fieldset
      values:
        0-dev: '<b>Development:</b> one master (1) and one scalable worker (1+)'
        1-prod: '<b>Production:</b> multi master (3) with API balancers (2+) and scalable workers (2+)'
      default: 0-dev
      showIf:
        1-prod:
          - type: spacer
            caption: Mail server
          - name: mailServerHost
            caption: Host
            type: string
            required: true
          - name: mailServerPort
            caption: Port
            type: string
            required: true
          - name: mailServerUsername
            caption: Username
            type: string
            required: true
          - name: mailServerPassword
            caption: Password
            type: string
            inputType: password
            required: true
          - name: mailServerEnableSsl
            caption: Enable SSL
            type: toggle
            value: true
    - name: kubernetesVersion
      type: string
      caption: Kubernetes version
      default: v1.23.6
    - type: spacer
      caption: IAM Service
    - name: useJelasticEmailAsAuthAdminEmail
      type: toggle
      caption: Use Jelastic Email
      value: true
      hidden: false
      showIf:
        false:
          name: authAdminEmail
          caption: Admin email
          type: string
          required: true
    - name: hasuraClaimsNamespace
      caption: Hasura Claims Namespace
      type: string
      default: https://hasura.io/jwt/claims
    - name: authIssuer
      caption: JWT issuer
      type: string
      default: your-company.com
    - name: fromEmail
      caption: From Email
      type: string
      required: true
    - name: fromName
      caption: From Name
      type: string
      required: true
    - type: spacer
      caption: Hasura
    - name: useAutoGeneratedHasuraAdminSecret
      type: toggle
      caption: Auto-generate Admin Secret
      value: true
      showIf:
        false:
          name: hasuraAdminSecret
          caption: Admin Secret
          type: string
          inputType: password
          required: true
    - type: spacer
      caption: SSL
    - name: useDefaultExternalDomain
      type: toggle
      caption: Use Default External Domain
      value: true
      hidden: false
      showIf:
        false:
          - name: externalDomains
            caption: External domain names (;-separated list)
            type: string
            vtype: domainlist
            required: true
    
globals:
  # postgres
  HASURA_DB_NAME: hasura
  HASURA_DB_USERNAME: hasura_user
  HASURA_DB_PASSWORD: ${fn.password(40)}
  AUTH_DB_NAME: fusionauth
  AUTH_DB_USERNAME: auth
  AUTH_DB_PASSWORD: ${fn.password(40)}
  # hasura
  HASURA_UNAUTHORIZED_ROLE: anonymous
  HASURA_ADMIN_SECRET_AUTO: ${fn.password(40)}
  HASURA_CLAIMS_NAMESPACE: https://hasura.io/jwt/claims
  # auth
  AUTH_ADMIN_PASSWORD: ${fn.password(40)}
  AUTH_ALMIGHTY_API_KEY: ${fn.password(40)}
  AUTH_SERVERLESS_API_KEY: ${fn.password(40)}
  JWT_KEY_ALGORITHM: RS256

install:
  - computeOptionalParams
  - installCluster
  # TODO: install ssl

actions:
  computeOptionalParams:
    - script: |
        return {
          result: 0,
          email: ${settings.useJelasticEmailAsAuthAdminEmail} ? "${user.email}" : "${settings.authAdminEmail}",
          hasuraAdminSecret: ${settings.useAutoGeneratedHasuraAdminSecret} ? "${globals.HASURA_ADMIN_SECRET_AUTO}" : "${settings.hasuraAdminSecret}",
          hasuraEnableConsole: "${settings.topo}" == "0-dev" ? "true" : "false",
          externalDomains: ${settings.useDefaultExternalDomain} ? "${env.domain}" : "${settings.externalDomains}",
          mailServer: {
            host: "${settings.topo}" == "0-dev" ? "mailhog.mail" : "${settings.mailServerHost}",
            port: "${settings.topo}" == "0-dev" ? 1025 : ${settings.mailServerPort},
            username: "${settings.topo}" == "0-dev" ? "" : ${settings.mailServerUsername},
            password: "${settings.topo}" == "0-dev" ? "" : ${settings.mailServerPassword},        
            ssl: "${settings.topo}" == "0-dev" ? "false" : "${settings.mailServerEnableSsl}",
          },
        };
    - setGlobals:
        USER_EMAIL: ${response.email}
        HASURA_ADMIN_SECRET: ${response.hasuraAdminSecret}
        HASURA_ENABLE_CONSOLE: ${response.hasuraEnableConsole}
        EXTERNAL_DOMAINS: ${response.externalDomains}
        MAIL_SERVER_HOST: ${response.mailServer.host}
        MAIL_SERVER_PORT: ${response.mailServer.port}
        MAIL_SERVER_USERNAME: ${response.mailServer.username}
        MAIL_SERVER_PASSWORD: ${response.mailServer.password}
        MAIL_SERVER_SSL: ${response.mailServer.ssl}
  installCluster:
    jps: https://github.com/jelastic-jps/kubernetes/blob/${settings.kubernetesVersion}/manifest.jps
    envName: ${settings.k8sEnvName}
    displayName: Jelasticozor Engine
    settings:
      deploy: cmd
      # TODO:
      # 4. install fusionauth
      # 6. install hasura graphql-engine
      cmd: |-
        [ "${settings.topo}" -eq "0-dev" ] && curl -fsSL ${baseUrl}/mailhog/install_mailhog.sh | /bin/sh -s ${baseUrl}
        curl -fsSL ${baseUrl}/logs-aggregation/install_graylog.sh | /bin/sh -s ${baseUrl}
        curl -fsSL ${baseUrl}/database/install_db.sh | /bin/sh -s ${baseUrl} ${globals.HASURA_DB_NAME} ${globals.HASURA_DB_USERNAME} ${globals.HASURA_DB_PASSWORD} ${globals.AUTH_DB_NAME} ${globals.AUTH_DB_USERNAME} ${globals.AUTH_DB_PASSWORD}
        curl -fsSL ${baseUrl}/faas/install_faas.sh | /bin/sh
        curl -fsSL ${baseUrl}/iam/install_iam.sh | /bin/sh -s "${baseUrl}" "${settings.topo}" "${globals.AUTH_DB_USERNAME}" "${globals.AUTH_DB_PASSWORD}" "${globals.AUTH_DB_NAME}" "${globals.USER_EMAIL}" "${globals.AUTH_ADMIN_PASSWORD}" "${globals.AUTH_ALMIGHTY_API_KEY}" "${globals.AUTH_SERVERLESS_API_KEY}" "${settings.authIssuer}" "${globals.MAIL_SERVER_HOST}" "${globals.MAIL_SERVER_PORT}" "${globals.MAIL_SERVER_USERNAME}" "${globals.MAIL_SERVER_PASSWORD}" "${globals.MAIL_SERVER_SSL}" "${settings.fromEmail}" "${settings.fromName}" "${settings.hasuraClaimsNamespace}" 
      topo: ${settings.topo}
      dashboard: general
      ingress-controller: Nginx
      storage: true
      api: true
      monitoring: true
      version: ${settings.kubernetesVersion}
      jaeger: false


# TODO: fix this!
# - provide hasura endpoint
success:
  text: |
    **Hasura Console**: [${env.protocol}://${env.domain}/](${env.protocol}://${env.domain}/)  
    **Hasura Admin Secret**: ${globals.HASURA_ADMIN_SECRET}  
    **Hasura Database Name**: ${globals.HASURA_DB_NAME}  
    **Hasura Database Username**: ${globals.HASURA_DB_USERNAME}  
    **Hasura Database Password**: ${globals.HASURA_DB_PASSWORD}  
    **Auth Admin Email**: ${globals.USER_EMAIL}  
    **Auth Admin Password**: ${globals.AUTH_ADMIN_PASSWORD}  
    **Auth Almighty API Key**: ${globals.AUTH_ALMIGHTY_API_KEY}  
    **Auth Serverless API Key**: ${globals.AUTH_SERVERLESS_API_KEY}  
    **Auth Database Name**: ${globals.AUTH_DB_NAME}  
    **Auth Database Username**: ${globals.AUTH_DB_USERNAME}  
    **Auth Database Password**: ${globals.AUTH_DB_PASSWORD}